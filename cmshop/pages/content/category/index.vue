<template>
  <div class="container mx-auto px-4 lg:px-0">
    <Modal :show="state.success" :type="'success'" title="Thành công" @close="state.success = false"
      @action="state.success = false" />
    <ConfirmModal :loadingState="true" :show="state.confirm" :list="selectedListConfirm"
      question="Bạn có chắc muốn xóa những danh mục này?" @close="state.confirm = false" @action="del" />
    <h1 class="text-4xl font-extrabold dark:text-white mb-8">Danh mục</h1>
    <div class="flex gap-x-4 items-center pb-4">
      <SuperButton to="/content/category/create" text="Thêm danh mục">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
          <path
            d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
        </svg>
      </SuperButton>
      <transition enter-active-class="animate-bounceIn animate-faster" leave-active-class="animate-bounceOut">
        <SuperButton v-if="selected.length" @click="state.confirm = true" color="red" text="Xóa mục đã chọn">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
            <path fill-rule="evenodd"
              d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z"
              clip-rule="evenodd" />
          </svg>
        </SuperButton>
      </transition>

    </div>
    <div v-if="$fetchState.error" role="alert">
      <svg aria-hidden="true" class="flex-shrink-0 w-5 h-5 text-red-700 dark:text-red-800" fill="currentColor"
        viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd"
          d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
          clip-rule="evenodd"></path>
      </svg>
      <span class="sr-only">Error</span>
      <div class="ml-3 text-sm font-medium text-red-700 dark:text-red-800">
        Lỗi khi tìm nạp dữ liệu
      </div>
      <button type="button"
        class="ml-auto -mx-1.5 -my-1.5 bg-red-100 text-red-500 rounded-lg focus:ring-2 focus:ring-red-400 p-1.5 hover:bg-red-200 inline-flex h-8 w-8 dark:bg-red-200 dark:text-red-600 dark:hover:bg-red-300"
        data-dismiss-target="#alert-2" aria-label="Close">
        <span class="sr-only">Close</span>
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>
    <div class="overflow-x-auto relative rounded-xl shadow-xl mb-4">
      <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
          <tr>
            <th scope="col" class="p-4">
              <div class="flex items-center">
                <input id="checkbox-all-search" type="checkbox" v-model="selectAll"
                  class="w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                <label for="checkbox-all-search" class="sr-only">checkbox</label>
              </div>
            </th>
            <th scope="col" class="py-3 px-6">
              Tên danh mục
            </th>
            <th scope="col" class="py-3 px-6">
              Mô tả
            </th>
            <th scope="col" class="py-3 px-6">
              Chỉnh sửa lần cuối
            </th>
            <th scope="col" class="py-3 px-6">
              Khởi tạo
            </th>
            <th scope="col" class="py-3 px-6">
              <span class="inline-flex items-center gap-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                  <path
                    d="M12.232 4.232a2.5 2.5 0 013.536 3.536l-1.225 1.224a.75.75 0 001.061 1.06l1.224-1.224a4 4 0 00-5.656-5.656l-3 3a4 4 0 00.225 5.865.75.75 0 00.977-1.138 2.5 2.5 0 01-.142-3.667l3-3z" />
                  <path
                    d="M11.603 7.963a.75.75 0 00-.977 1.138 2.5 2.5 0 01.142 3.667l-3 3a2.5 2.5 0 01-3.536-3.536l1.225-1.224a.75.75 0 00-1.061-1.06l-1.224 1.224a4 4 0 105.656 5.656l3-3a4 4 0 00-.225-5.865z" />
                </svg>
                Liên kết
              </span>
            </th>
            <!-- <th scope="col" class="py-3 px-6">
              Action
            </th> -->
          </tr>
        </thead>
        <tbody v-if="$fetchState.pending || state.loading">
          <tr v-for="n in 5" :key="n"
            class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 animate-twPulse">
            <td class="p-4 w-4">
              <div class="flex items-center">
                <input id="checkbox-table-search-1" type="checkbox" disabled
                  class="w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                <label for="checkbox-table-search-1" class="sr-only">checkbox</label>
              </div>
            </td>
            <th scope="row" class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap dark:text-white">
              <div class="h-2.5 bg-gray-300 rounded-full dark:bg-gray-600 w-24 mb-2.5"></div>
            </th>
            <td class="py-4 px-6">
              <div class="w-32 h-2 bg-gray-200 rounded-full dark:bg-gray-700"></div>
            </td>
            <td class="py-4 px-6">
              <div class="w-32 h-2 bg-gray-200 rounded-full dark:bg-gray-700"></div>
            </td>
            <td class="py-4 px-6">
              <div class="w-32 h-2 bg-gray-200 rounded-full dark:bg-gray-700"></div>
            </td>
            <td class="py-4 px-6">
              <div class="w-32 h-2 bg-gray-200 rounded-full dark:bg-gray-700"></div>
            </td>
          </tr>

        </tbody>
        <tbody v-else>
          <tr v-if="!categories.length">
            <td colspan="1000" class="p-4 text-center">
              Không có dữ liệu
            </td>
          </tr>
          <tr v-for="(category) in categories" :key="category.id"
            class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
            <td class="p-4 w-4">
              <div class="flex items-center">
                <input id="checkbox-table-search-1" type="checkbox" v-model="selected" :value="category"
                  class="w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                <label for="checkbox-table-search-1" class="sr-only">checkbox</label>
              </div>
            </td>
            <th scope="row" class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap dark:text-white cursor-pointer"
              @click="$router.push({ path: '/content/category/' + category.id })">
              {{ category.name }}
            </th>
            <td class="py-4 px-6 cursor-pointer" @click="$router.push({ path: '/content/category/' + category.id })">
              <span v-once> {{ category.desc ?? '&lt;trống&gt;' }}</span>
            </td>
            <td class="py-4 px-6 cursor-pointer" @click="$router.push({ path: '/content/category/' + category.id })">
              {{ category.updated_at }}
            </td>
            <td class="py-4 px-6 cursor-pointer" @click="$router.push({ path: '/content/category/' + category.id })">
              {{ category.created_at }}
            </td>
            <td class="py-4 px-6">
              <Link :href="`${baseUrlShop}/${category.slug}`" color="blue" :text="`${baseUrlShop}/${category.slug}`" />
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <nav class="flex justify-between items-center pt-4" aria-label="Table navigation">
      <span class="text-sm font-normal text-gray-500 dark:text-gray-400">Showing <span
          class="font-semibold text-gray-900 dark:text-white">{{ pagination.from }}-{{ pagination.to}}</span> of <span
          class="font-semibold text-gray-900 dark:text-white">{{ pagination.total}}</span></span>

      <ul class="inline-flex -space-x-px">
        <li  v-for="(link, index) in pagination.links" :key="index" >
          <button v-html="link.label" @click="paginate(link.url)" :disabled="link.url == null"
            :class="(link.url == null ? 'cursor-not-allowed bg-gray-200/50 ' : '') + (index == 0  ? 'rounded-l-lg ' :  (index == (pagination.links.length - 1) ? 'rounded-r-lg ' : (link.active ? 'text-blue-600 bg-blue-50 ' : 'text-gray-500 bg-white ')))+ 'py-2 px-3 ml-0 leading-tight border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white'"></button>
        </li>
      </ul>

    </nav>

  </div>

</template>

<script>
export default {
  name: 'ContentCategory',
  transition: {
    enterActiveClass: 'animate-fadeIn',
  },
  data: function () {
    return {
      pagination: {},
      categories: [],
      baseUrlShop: '',
      selected: [],
      state: {
        confirm: false,
        success: false,
        loading: false,
      }
    }
  },
  async fetch() {
    const categories = await this.$axios.get('/content/categories')
    this.pagination = categories.data
    this.categories = this.pagination.data;
    this.baseUrlShop = process.env.baseUrlShop
  },
  // async asyncData({ $axios }) {
  //   const category = await $axios.get('/content/categories')
  //   return { categories: category.data }
  // },
  methods: {
    async paginate(url) {
      this.state.loading = true
      const categories = await this.$axios.get(url)
      this.state.loading = false
      this.pagination = categories.data
      this.categories = this.pagination.data;
      this.selected = []
    },
    async del(callback) {
      let removed = [];
      try {
        for (const [i, category] of this.selected.entries()) {
          await this.$axios.delete('/content/categories/' + category.id)
          this.$toast.global.success({
            message: `Đã xóa ${category.name}`
          })
          this.categories.splice(this.categories.findIndex(c => c.id === category.id), 1)
          removed.push(i)

          if (this.categories.length == 0 && this.pagination.prev_page_url != null) {
            this.paginate(this.pagination.prev_page_url)
          }
        }
        callback()
        this.state.success = true
      } catch (e) {
        console.log(e)
        callback()
        this.$toast.global.myError()
      } finally {
        removed.forEach((i) => {
          this.selected.splice(i, 1)
        })

      }
    }
  },
  computed: {
    selectedListConfirm() {
      let list = [];
      this.selected.forEach(function (category) {
        list.push(`${category.name} (${category.slug})`)
      })

      return list
    },
    selectAll: {
      get: function () {
        if (this.$fetchState.pending) return false;
        return this.categories ? this.selected.length == this.categories.length : false;
      },
      set: function (value) {
        var selected = [];

        if (value) {
          this.categories.forEach(function (category) {
            selected.push(category);
          });
        }

        this.selected = selected;
      }
    }
  }

}
</script>
